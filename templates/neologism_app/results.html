{% extends 'neologism_app/base.html' %}

{% block title %}Resultados da Detecção{% endblock %}

{% block content %}
<div class="results">
    <div class="results-header">
        <h3>Resultados da Análise</h3>
        <div class="stats">
            <span>Total de palavras: <strong id="total-words">{{ total_words }}</strong></span>
            <span>Neologismos detectados: <strong id="num-neologisms">{{ num_neologisms }}</strong></span>
        </div>
    </div>
    
    <p class="status-message status-info">Clique nas palavras marcadas para mais informações. Use a lista de candidatos abaixo para validar neologismos ou adicioná-los ao seu léxico.</p>

    <div class="processed-text" id="processed-text-display">
        {{ processed_text_html|safe }}
    </div>

    {% if neologism_candidates %}
    <div class="candidate-list">
        <h3>Candidatos a Neologismos</h3>
        <p class="status-message status-info">Clique em "Não é neologismo" para adicionar a palavra ao seu léxico pessoal e não a marcar mais no futuro.</p>
        <div id="neologism-candidate-container">
            {% for candidate in neologism_candidates %}
            <div class="candidate-item" id="candidate-{{ forloop.counter }}">
                <div class="candidate-info">
                    <span class="candidate-word">{{ candidate.word }}</span>
                    <span class="candidate-pos">({{ candidate.pos|lower }})</span>
                </div>
                <div class="candidate-actions">
                    <!-- Apenas um botão agora: "Não é neologismo" -->
                    <button class="btn btn-small btn-reject validate-btn" data-word="{{ candidate.word }}" data-action="reject_neologism">Não é neologismo</button>
                    <!-- O botão "Aceitar neologismo" foi removido daqui para focar na validação "não é neologismo" -->
                </div>
            </div>
            {% endfor %}
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <a href="{% url 'neologism_app:export_csv' %}" class="btn btn-primary" id="export-csv-btn">Exportar para CSV</a>
        </div>
    </div>
    {% else %}
    <p class="status-message status-complete">Nenhum neologismo detectado neste texto ou todos já foram validados!</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const validateButtons = document.querySelectorAll('.validate-btn');
        const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]');
        if (!csrftoken) {
            console.error('Token CSRF não encontrado!');
            showAjaxMessage('Erro: Token CSRF não encontrado. Recarregue a página.', 'error');
            return;
        }
        const processedTextDisplay = document.getElementById('processed-text-display');
        const neologismCandidateContainer = document.getElementById('neologism-candidate-container');
        const totalWordsSpan = document.getElementById('total-words');
        const numNeologismsSpan = document.getElementById('num-neologisms');
        const ajaxMessageContainer = document.getElementById('ajax-message-container');

        function showAjaxMessage(message, type = 'info') { // type: 'success', 'error', 'info', 'processing'
            ajaxMessageContainer.textContent = message;
            ajaxMessageContainer.classList.remove('hidden', 'status-processing', 'status-complete', 'status-error', 'status-info', 'status-success');
            ajaxMessageContainer.classList.add(`status-${type}`);
            ajaxMessageContainer.classList.remove('hidden'); // Garante que esteja visível
            setTimeout(() => {
                ajaxMessageContainer.classList.add('hidden'); // Esconde após 5 segundos
            }, 5000);
        }

        validateButtons.forEach(button => {
            button.addEventListener('click', function() {
                const word = this.dataset.word;
                const action = this.dataset.action; // Será sempre 'reject_neologism' agora
                const candidateItem = this.closest('.candidate-item');

                showAjaxMessage('Processando...', 'processing');

                fetch('/validate_neologism/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken.value,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `word=${encodeURIComponent(word)}&action=${encodeURIComponent(action)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'info') {
                        showAjaxMessage(data.message, data.status); 

                        // 1. Remover o item da lista de candidatos
                        if (candidateItem) {
                            candidateItem.remove();
                            
                            // 2. Atualizar a contagem de neologismos na UI
                            let currentNumNeologisms = parseInt(numNeologismsSpan.textContent);
                            numNeologismsSpan.textContent = Math.max(0, currentNumNeologisms - 1);

                            // 3. Remover a marcação do texto processado
                            // Seleciona todas as ocorrências da palavra marcada no texto
                            const markedWords = processedTextDisplay.querySelectorAll(`.neologism[data-word="${word}"]`);
                            markedWords.forEach(el => {
                                // Substitui o elemento span pelo seu conteúdo de texto puro
                                // Isso remove o destaque sem alterar o texto original ou os espaços
                                const textNode = document.createTextNode(el.textContent);
                                el.parentNode.replaceChild(textNode, el);
                            });
                        }
                        
                        // Verificar se a lista de candidatos ficou vazia para exibir a mensagem final
                        if (neologismCandidateContainer && neologismCandidateContainer.children.length === 0) {
                            const candidateListSection = neologismCandidateContainer.closest('.candidate-list');
                            if (candidateListSection) {
                                candidateListSection.innerHTML = '<p class="status-message status-complete">Todos os candidatos foram validados!</p>';
                            }
                        }

                    } else {
                        showAjaxMessage('Erro: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição AJAX:', error);
                    showAjaxMessage('Ocorreu um erro ao processar sua solicitação.', 'error');
                });
            });
        });

        // Adicionar funcionalidade para o clique nos neologismos no texto (opcional)
        // Isso pode exibir um tooltip ou modal com mais informações (POS, sugestão de formação)
        // Por enquanto, apenas um alerta simples.
        processedTextDisplay.addEventListener('click', function(event) {
            const target = event.target;
            if (target.classList.contains('neologism')) {
                const word = target.dataset.word;
                const pos = target.dataset.pos; // Já vem em português
                const lemma = target.dataset.lemma;
                
                let info = `Palavra: ${word}\n`;
                info += `Classe Gramatical: ${pos}\n`;
                info += `Lema: ${lemma}\n`;
                
                alert(`Detalhes do Neologismo:\n${info}`);
            }
        });
    });
</script>
{% endblock %}