{% extends 'base.html' %}
{% load static %}

{% block title %}Hist√≥rico de An√°lises - Detector de Neologismos{% endblock %}

{% block content %}
<div class="results">
    <div class="results-header">
        <h3>Hist√≥rico de An√°lises</h3>
        <div class="stats">
            <span>Total de an√°lises: <span id="totalAnalyses">{{ analyses|length }}</span></span>
            <span>Neologismos √∫nicos: <span id="uniqueNeologisms">{{ unique_neologisms_count }}</span></span>
        </div>
    </div>

    {% if analyses %}
        <div class="candidate-list">
            <h4>An√°lises Recentes</h4>
            {% for analysis in analyses %}
                <div class="candidate-item">
                    <div style="flex: 1;">
                        <div class="candidate-word">
                            An√°lise #{{ analysis.id }}
                        </div>
                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            {{ analysis.created_at|date:"d/m/Y H:i" }} ‚Ä¢ 
                            {{ analysis.word_count }} palavras ‚Ä¢ 
                            {{ analysis.neologisms.count }} neologismo{{ analysis.neologisms.count|pluralize }}
                        </div>
                        <div style="font-size: 14px; color: #2c3e50; margin-top: 8px; max-width: 600px;">
                            {{ analysis.original_text|truncatechars:100 }}
                        </div>
                        {% if analysis.neologisms.exists %}
                            <div style="margin-top: 8px;">
                                <strong>Neologismos:</strong>
                                {% for neologism in analysis.neologisms.all %}
                                    <span class="neologism" style="margin-right: 5px; font-size: 12px;">
                                        {{ neologism.word }}
                                    </span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="candidate-actions">
                        <a href="{% url 'detector:analysis_detail' analysis.id %}" class="btn btn-small btn-accept">
                            üëÅÔ∏è Ver Detalhes
                        </a>
                        <form method="post" action="{% url 'detector:delete_analysis' analysis.id %}" 
                              style="display: inline;"
                              onsubmit="return confirm('Tem certeza que deseja excluir esta an√°lise?')">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-small btn-reject">
                                üóëÔ∏è Excluir
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagina√ß√£o -->
        {% if is_paginated %}
            <div class="controls" style="justify-content: center; margin-top: 20px;">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="btn btn-secondary">¬´ Primeira</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-secondary">‚Äπ Anterior</a>
                {% endif %}
                
                <span style="padding: 12px 25px; color: #2c3e50; font-weight: 600;">
                    P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="btn btn-secondary">Pr√≥xima ‚Ä∫</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-secondary">√öltima ¬ª</a>
                {% endif %}
            </div>
        {% endif %}
    {% else %}
        <div class="candidate-list">
            <p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 40px;">
                Nenhuma an√°lise encontrada. 
                <a href="{% url 'detector:index' %}" style="color: #3498db;">
                    Fa√ßa sua primeira an√°lise agora!
                </a>
            </p>
        </div>
    {% endif %}

    <!-- Estat√≠sticas Gerais -->
    {% if analyses %}
        <div class="candidate-list">
            <h4>Estat√≠sticas Gerais</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: #3498db;">
                        {{ total_words }}
                    </div>
                    <div style="font-size: 14px; color: #7f8c8d;">
                        Total de palavras analisadas
                    </div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: #e74c3c;">
                        {{ unique_neologisms_count }}
                    </div>
                    <div style="font-size: 14px; color: #7f8c8d;">
                        Neologismos √∫nicos detectados
                    </div>
                </div>
                <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: #27ae60;">
                        {{ avg_neologisms_per_analysis|floatformat:1 }}
                    </div>
                    <div style="font-size: 14px; color: #7f8c8d;">
                        M√©dia de neologismos por an√°lise
                    </div>
                </div>
            </div>
        </div>

        <!-- Neologismos Mais Frequentes -->
        {% if most_frequent_neologisms %}
            <div class="candidate-list">
                <h4>Neologismos Mais Frequentes</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
                    {% for item in most_frequent_neologisms %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
                            <span class="neologism" style="font-size: 12px; margin-right: 8px;">
                                {{ item.word }}
                            </span>
                            <span style="font-size: 12px; color: #7f8c8d; font-weight: 600;">
                                {{ item.count }}x
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- Filtros e Busca -->
    <div class="candidate-list">
        <h4>Filtros</h4>
        <form method="get" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; font-size: 14px; color: #2c3e50; margin-bottom: 5px;">
                    Buscar por texto:
                </label>
                <input type="text" name="search" value="{{ request.GET.search }}" 
                       placeholder="Digite palavras-chave..." 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
            </div>
            <div style="min-width: 120px;">
                <label style="display: block; font-size: 14px; color: #2c3e50; margin-bottom: 5px;">
                    Data inicial:
                </label>
                <input type="date" name="date_from" value="{{ request.GET.date_from }}" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
            </div>
            <div style="min-width: 120px;">
                <label style="display: block; font-size: 14px; color: #2c3e50; margin-bottom: 5px;">
                    Data final:
                </label>
                <input type="date" name="date_to" value="{{ request.GET.date_to }}" 
                       style="width: 100%; padding: 8px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
            </div>
            <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                üîç Filtrar
            </button>
            <a href="{% url 'detector:history' %}" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                üîÑ Limpar
            </a>
        </form>
    </div>

    <!-- A√ß√µes -->
    <div class="controls">
        <a href="{% url 'detector:index' %}" class="btn btn-primary">
            üîç Nova An√°lise
        </a>
        {% if analyses %}
            <button type="button" class="btn btn-secondary" onclick="exportHistory()">
                üìÑ Exportar Hist√≥rico
            </button>
            <form method="post" action="{% url 'detector:clear_history' %}" 
                  style="display: inline;"
                  onsubmit="return confirm('Tem certeza que deseja limpar todo o hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.')">
                {% csrf_token %}
                <button type="submit" class="btn btn-reject">
                    üóëÔ∏è Limpar Hist√≥rico
                </button>
            </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function exportHistory() {
        const historyData = {
            total_analyses: {{ analyses|length }},
            unique_neologisms: {{ unique_neologisms_count }},
            total_words: {{ total_words }},
            avg_neologisms_per_analysis: {{ avg_neologisms_per_analysis|floatformat:2 }},
            analyses: [
                {% for analysis in analyses %}
                {
                    id: {{ analysis.id }},
                    created_at: "{{ analysis.created_at|date:'Y-m-d H:i:s' }}",
                    word_count: {{ analysis.word_count }},
                    neologisms_count: {{ analysis.neologisms.count }},
                    original_text: `{{ analysis.original_text|escapejs }}`,
                    neologisms: [
                        {% for neologism in analysis.neologisms.all %}
                        {
                            word: "{{ neologism.word }}",
                            definition: "{{ neologism.definition|default:'' }}",
                            is_validated: {{ neologism.is_validated|yesno:"true,false" }}
                        }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            most_frequent_neologisms: [
                {% for item in most_frequent_neologisms %}
                {
                    word: "{{ item.word }}",
                    count: {{ item.count }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            export_date: new Date().toISOString()
        };

        // Criar e baixar arquivo JSON
        const dataStr = JSON.stringify(historyData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'historico_neologismos_' + new Date().toISOString().split('T')[0] + '.json';
        link.click();
        URL.revokeObjectURL(url);
        
        // Feedback visual
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úì Exportado!';
        button.style.background = '#27ae60';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '';
        }, 2000);
    }

    // Anima√ß√£o de remo√ß√£o quando an√°lise √© exclu√≠da
    document.querySelectorAll('form[action*="delete_analysis"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            const candidateItem = this.closest('.candidate-item');
            const button = this.querySelector('button');
            
            // Feedback visual
            button.disabled = true;
            button.textContent = 'üóëÔ∏è Excluindo...';
            button.style.opacity = '0.6';
        });
    });

    // Auto-atualiza√ß√£o dos filtros de data
    document.addEventListener('DOMContentLoaded', function() {
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Validar se data inicial n√£o √© posterior √† data final
                const dateFrom = document.querySelector('input[name="date_from"]').value;
                const dateTo = document.querySelector('input[name="date_to"]').value;
                
                if (dateFrom && dateTo && new Date(dateFrom) > new Date(dateTo)) {
                    alert('A data inicial n√£o pode ser posterior √† data final.');
                    this.value = '';
                }
            });
        });
    });

    // Busca em tempo real (com debounce)
    let searchTimeout;
    document.querySelector('input[name="search"]')?.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            // Aqui voc√™ pode implementar busca AJAX se desejar
            // Por enquanto, manteremos o comportamento padr√£o do formul√°rio
        }, 500);
    });

    // Marcar an√°lises como lidas (opcional)
    function markAsRead(analysisId) {
        fetch(`/detector/mark-read/${analysisId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        });
    }

    // Confirmar limpeza do hist√≥rico
    document.querySelector('form[action*="clear_history"]')?.addEventListener('submit', function(e) {
        const analysesCount = {{ analyses|length }};
        if (!confirm(`Tem certeza que deseja excluir todas as ${analysesCount} an√°lises? Esta a√ß√£o n√£o pode ser desfeita.`)) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}